<!DOCTYPE html> 
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dados da Conta</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px;
    padding: 0;
  }

  h1, h2, p {
    text-align: left;
    margin: 5px 0;
  }

  table {
    border-collapse: collapse;
    max-width: 600px;
    font-size: 14px;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 6px 8px;
    text-align: left;
  }

  th {
    background-color: #f2f2f2;
  }

  tfoot td {
    font-weight: bold;
    background-color: #f0f0f0;
  }

  @media (max-width: 480px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    th, td {
      width: 100%;
      box-sizing: border-box;
      text-align: left;
    }
    thead tr {
      display: none;
    }
    tbody tr {
      margin-bottom: 10px;
      border: 1px solid #ddd;
      padding: 5px;
    }
    tfoot td {
      display: block;
      width: 100%;
    }
  }
</style>
</head>
<body>

  <!-- Resumo da Conta de Operação (removido/comentado)
  <h2>Resumo da Conta de Operacao</h2>
  <p><strong>Saldo:</strong> <span id="saldo">0</span></p>
  <p><strong>Lucro:</strong> <span id="lucro">0</span></p>
  <p><strong>Capital Líquido:</strong> <span id="capitalLiquido">0</span></p>
  -->

  <h2>Resumo do Investimento</h2>
  <table>
  <thead>
    <tr>
      <th>nome do<br>investidor</th>
      <th>capital<br>investido em euros</th>
      <th>% nos<br>resultados</th>
      <th>divisão dos<br>lucro/prejuizo em euros</th>
      <th>valor disponivel<br>para saque em euros</th>
    </tr>
  </thead>
  <tbody id="investidores">
  <tr data-nome="Andres">
    <td>Andres</td>
    <td class="deposito">0.00</td>  <!-- Capital inicial atualizado -->
    <td class="percent">0%</td>
    <td class="lucro">0.00</td>
    <td class="capital">0.00</td>
  </tr>
  <tr data-nome="Bruno">
    <td>Bruno</td>
    <td class="deposito">848.17</td> <!-- Capital inicial atualizado -->
    <td class="percent">0%</td>
    <td class="lucro">0.00</td>
    <td class="capital">0.00</td>
  </tr>
  <tr data-nome="Marlucia">
    <td>Marlucia</td>
    <td class="deposito">300.00</td> <!-- Capital inicial atualizado -->
    <td class="percent">0%</td>
    <td class="lucro">0.00</td>
    <td class="capital">0.00</td>
  </tr>

</tbody>

  <tfoot>
    <tr id="totais" style="font-weight:bold; background-color:#f0f0f0;">
      <td>Total</td>
      <td id="total-deposito">0.00</td>
      <td>100%</td>
      <td id="total-lucro">0.00</td>
      <td id="total-capital">0.00</td>
    </tr>
  </tfoot>
</table>

<p id="atualizacao">Última atualização: --:--:--</p>

<script>
async function atualizarDados() {
  try {
    const res = await fetch('/api/metatrader'); 
    if (!res.ok) throw new Error('Erro ao buscar dados');
    const data = await res.json();

    // Calcula soma dos depósitos manuais (do HTML)
    const rows = document.querySelectorAll("#investidores tr");
    let somaDepositos = 0;
    rows.forEach(tr => {
      somaDepositos += parseFloat(tr.querySelector(".deposito").innerText);
    });

    // Distribui lucro proporcionalmente
    rows.forEach(tr => {
      const deposito = parseFloat(tr.querySelector(".deposito").innerText);
      const percent = deposito / somaDepositos;

      const capital = percent * data.capitalLiquido;
      const lucro = capital - deposito;

      tr.querySelector(".percent").innerText = (percent * 100).toFixed(2) + "%";
      tr.querySelector(".lucro").innerText = lucro.toFixed(2);
      tr.querySelector(".capital").innerText = capital.toFixed(2);
    });

    // Atualiza totais
    let totalDeposito = 0, totalLucro = 0, totalCapital = 0;
    rows.forEach(tr => {
      totalDeposito += parseFloat(tr.querySelector(".deposito").innerText);
      totalLucro += parseFloat(tr.querySelector(".lucro").innerText);
      totalCapital += parseFloat(tr.querySelector(".capital").innerText);
    });
    document.getElementById("total-deposito").innerText = totalDeposito.toFixed(2);
    document.getElementById("total-lucro").innerText = totalLucro.toFixed(2);
    document.getElementById("total-capital").innerText = totalCapital.toFixed(2);

    // Atualiza horário da última atualização
    const dataAtualizacao = new Date(data.createdAt);
    const h = String(dataAtualizacao.getHours()).padStart(2,'0');
    const m = String(dataAtualizacao.getMinutes()).padStart(2,'0');
    const s = String(dataAtualizacao.getSeconds()).padStart(2,'0');
    document.getElementById('atualizacao').innerText = `Última atualização: ${h}:${m}:${s}`;

  } catch (err) {
    console.error(err);
  }
}

// Atualiza uma vez ao carregar a página
atualizarDados();
</script>

</body>
</html>
